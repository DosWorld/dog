
<html>
<head>
<title>../../SRC/SE.C</title>
<meta name="generator" content="c2html 0.9.2">
<meta name="date" content="2000-04-13T18:50:42+00:00">
</head>

<body bgcolor="#FFFFFF">
<?php
    $title="DOG - Developer - Source";
  include("../include/head.php");
?>
  
<!-- Left side -->
  
<?php include("../include/dleft.htmlf"); ?>
  
<!-- Right side -->
<TD>
<pre width="80"><font color="#B22222">/*

SE.C - DOG - Alternate command processor for (currently) MS-DOS ver 3.30

Copyright (C) 1999,2000 Wolf Bergenheim

This program is free software; you can redistribute it and/or
modify it under the terms of the GNU General Public License
as published by the Free Software Foundation; either version 2
of the License, or (at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program; if not, write to the Free Software
Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.

Developers:
</font><strong><font color="#4169E1"><a name="Bergenheim"></a>Wolf Bergenheim (WB)</font></strong>

History
18.03.00 - Extracted from DOG.C - WB

**************************************************************************/

<strong><font color="#4169E1"><a name="do_se"></a>void do_se( BYTE n)</font></strong>
{
    BYTE b,*p;
    WORD w;

    <font color="#4169E1">if</font>(n == 1) {
        printf(<font color="#666666">"env @ %Fp %u(%xh) bytes\n"</font>,_env,envsz,envsz);
        <font color="#4169E1">for</font>(w=0;w&lt;envsz;w++) {
            <font color="#4169E1">if</font>(*(_env+w)== 0) {
                <font color="#4169E1">if</font>(*(_env+w+1) == 0)
                    <font color="#4169E1">break</font>;
                <font color="#4169E1">else</font>
                    puts(<font color="#666666">""</font>);
            }
            <font color="#4169E1">else</font>
                printf(<font color="#666666">"%Fc"</font>,*(_env+w));
        
        }
        printf(<font color="#666666">"\n\n"</font>);
    }
    <font color="#4169E1">else</font> {
        p = malloc(200);
        p[0] = '\0';
        <font color="#4169E1">for</font>(b=2;b&lt;n;b++) {
            strcat(p,arg[b]);
            strcat(p,<font color="#666666">" "</font>);
        }
        <font color="#4169E1">if</font> (strlen(p) == 0) p = NULL;
        setevar(arg[1],p);
        free(p);
    }
    
}


<font color="#B22222">/****************************************************************************/</font>

<strong><font color="#4169E1"><a name="getevar"></a>BYTE *getevar(BYTE *varname, BYTE *value)</font></strong>
{
    BYTE *p,*q,ev[512];
    WORD nlen;

    p=varname;
    q=value;
    nlen = strlen(p);

    <font color="#4169E1">while</font>(*_env) {
        <font color="#4169E1">if</font>(*(_env+nlen) == '=') { <font color="#B22222">/*possible match */</font>
            *(_env+nlen) = '\0';
            sprintf(ev,<font color="#666666">"%Fs"</font>,_env);
            *(_env+nlen) = '=';
            <font color="#4169E1">if</font>(stricmp(varname,ev) == 0) { <font color="#B22222">/*found it! */</font>
                _env += nlen+1;
                <font color="#4169E1">while</font>(*_env != '\0') {
                    *(q++) = *(_env++);
                }
                <font color="#B22222">/* restore _env */</font>
                *q='\0';
                _env=MK_FP(envseg,0);
                <font color="#4169E1">return</font> value;
            }
            <font color="#4169E1">else</font> { <font color="#B22222">/* no match in _env to next */</font>
                <font color="#4169E1">while</font>(*(_env++) != '\0');
            }
        }
        <font color="#4169E1">else</font> { <font color="#B22222">/*no match */</font>
            <font color="#4169E1">while</font>(*(_env++) != '\0');
        }
    } <font color="#B22222">/* _env points to '\0' if end of env */</font>

    <font color="#B22222">/* env not found return NULL */</font>
    <font color="#B22222">/* restore _env */</font>
    _env=MK_FP(envseg,0);
    <font color="#4169E1">return</font> NULL;
}

<font color="#B22222">/****************************************************************************/</font>

<strong><font color="#4169E1"><a name="setevar"></a>void setevar(BYTE *varname, BYTE *value)</font></strong>
{
    BYTE t[512],far *rest,*p,*b,i,far *eoe, far *evalue,found=0;
    WORD w,ss,writesize,nlen,envleft;

    nlen = strlen(varname);
    writesize = strlen(varname)+strlen(value)+2; <font color="#B22222">/* = strings + 0 + '='*/</font>
    b=malloc(writesize);
    strupr(varname);
    strcpy(b,varname);
    strcat(b,<font color="#666666">"="</font>);
    strcat(b,value);
    envsz = peek(envseg-1,3) &lt;&lt; 4;

    evalue = eoe = rest = _env;


    <font color="#B22222">/* make eoe point to last byte of used env */</font>

    <font color="#4169E1">for</font>(w=0;w&lt;envsz;w++,eoe++) {
        <font color="#4169E1">if</font>(*eoe== 0) {
            <font color="#4169E1">if</font>(*(++eoe) == 0) {
                i = *(++eoe);
                eoe+=2;
                 <font color="#4169E1">while</font>(i&gt;0) {
                    <font color="#4169E1">while</font>(*(eoe++) != '\0');
                    i--;
                    }

                <font color="#4169E1">break</font>;
            }

        }
        <font color="#4169E1">else</font> {
        }
    }

    <font color="#B22222">/* check if var exists, if it does write new value in place of old
                            if not then write new var to end of env */</font>


    <font color="#4169E1">while</font>(*rest!='\0') {
        <font color="#4169E1">if</font>(*(rest+nlen) == '=') { <font color="#B22222">/*possible match */</font>
            *(rest+nlen) = '\0';
            sprintf(t,<font color="#666666">"%Fs"</font>,rest);
            *(rest+nlen) = '=';
            <font color="#4169E1">if</font>(stricmp(varname,t) == 0) { <font color="#B22222">/*found it! */</font>
                <font color="#B22222">/*save pos*/</font>
                evalue = rest;
                <font color="#B22222">/* make rest point to next var */</font> 
                <font color="#4169E1">while</font>(*(rest++)!='\0');
                <font color="#B22222">/*bail out */</font>
                found = 1;
                <font color="#4169E1">break</font>;
            }
            <font color="#4169E1">else</font> { <font color="#B22222">/* no match; point rest to next */</font>
                <font color="#4169E1">while</font>(*(rest++));
            }
        }
        <font color="#4169E1">else</font> { <font color="#B22222">/*no match */</font>
            <font color="#4169E1">while</font>(*(rest++)!='\0');
        }
    } <font color="#B22222">/* rest points to '\0' if end of env */</font>
    <font color="#4169E1">if</font>(found==0)
        evalue = rest;

    sprintf(t,<font color="#666666">"%Fs"</font>,evalue);
    <font color="#B22222">/* calculate the number of bytes left in the env. */</font>
    envleft = envsz - FP_OFF(eoe) + (found * strlen(t));

    <font color="#4169E1">if</font>(writesize &gt; envleft) {
        puts(<font color="#666666">"Out of environment space"</font>);
        <font color="#4169E1">return</font>;
    }

    <font color="#B22222">/*calc save size */</font>
    ss = FP_OFF(eoe) - FP_OFF(rest) + 1;

    <font color="#B22222">/*save rest of environment*/</font>
    p=malloc(ss);
    <font color="#4169E1">for</font>(w=0;w&lt;ss;w++) {
        *(p+w) = *(rest+w);
    }


    <font color="#4169E1">if</font>((found == 1) &amp;&amp; (value == NULL)) {
        w=0;
        <font color="#B22222">/*the env var will be owerwritten with rest.*/</font>
    }
    <font color="#4169E1">else</font> { <font color="#B22222">/*write value to environment. evalue points*/</font>
        <font color="#4169E1">for</font>(w=0;w&lt;writesize;w++) {
            *(evalue+w) = *(b+w);
        }
    }
    evalue += w;

    <font color="#B22222">/*put the rest back*/</font>
    <font color="#4169E1">for</font>(w=0;w&lt;ss;w++) {
        *(evalue+w) = *(p+w);
    }

    free(p);
    free(b);

    <font color="#4169E1">return</font>;
}


</pre>


<!-- END of Table-->
</TD></tr></table>


</body>
</html>
</body>

</html>
