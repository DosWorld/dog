
<html>
<head>
<title>../../SRC/BAT.C</title>
<meta name="generator" content="c2html 0.9.2">
<meta name="date" content="2000-08-18T10:09:57+00:00">
</head>

<body bgcolor="#FFFFFF">
<?php
    $title="DOG - Developer - Source";
  include("../include/head.php");
?>
  
<!-- Left side -->
  
<?php include("../include/dleft.htmlf"); ?>
  
<!-- Right side -->
<TD>
<pre width="80"><font color="#B22222">/*BAT.C  -  Alternate command processor for (currently) MS-DOS ver 3.30

Copyright (C) 1999  Wolf Bergenheim

This program is free software; you can redistribute it and/or
modify it under the terms of the GNU General Public License
as published by the Free Software Foundation; either version 2
of the License, or (at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program; if not, write to the Free Software
Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.

History

06.05.99 - BAT.C is a now also ported.

*/</font>
<strong><font color="#228B22">#define _BAT_COMS 8</font></strong>

<strong><font color="#228B22">#define B_C_CA 0</font></strong>
<strong><font color="#228B22">#define B_C_DO 1</font></strong>
<strong><font color="#228B22">#define B_C_44 2</font></strong>
<strong><font color="#228B22">#define B_C_GO 3</font></strong>
<strong><font color="#228B22">#define B_C_IF 4</font></strong>
<strong><font color="#228B22">#define B_C_IN 5</font></strong>
<strong><font color="#228B22">#define B_C_SH 6</font></strong>
<strong><font color="#228B22">#define B_C_TI 7</font></strong>

BYTE batch[_BAT_COMS][3] = {
    <font color="#666666">"CA"</font>,  <font color="#B22222">/*call */</font>
    <font color="#666666">"DO"</font>,  <font color="#B22222">/*DO   */</font>
    <font color="#666666">"44"</font>,  <font color="#B22222">/*FOR  */</font>
    <font color="#666666">"GO"</font>,  <font color="#B22222">/*goto */</font>
    <font color="#666666">"IF"</font>,  <font color="#B22222">/*If   */</font>
    <font color="#666666">"IN"</font>,  <font color="#B22222">/*input*/</font>
    <font color="#666666">"SH"</font>,  <font color="#B22222">/*shift*/</font>
    <font color="#666666">"TI"</font>   <font color="#B22222">/*Timer*/</font>
};



<font color="#B22222">/***************************************************************************/</font>

<strong><font color="#4169E1"><a name="parse_vars"></a>void parse_vars(BYTE *s,BYTE *t)</font></strong>
{

	BYTE *p,l,*e,i;

	*t = 0;
	l = strlen(s);

	e = t;

	<font color="#4169E1">for</font>(i=0;i&lt;l;i++) {
		<font color="#4169E1">if</font>(s[i] == '$') {
			<font color="#4169E1">if</font>(isdigit(s[++i])) {
				strcat(t,bf-&gt;args[s[i] -'0']);
<font color="#A020F0">#ifdef parse_debug</font>
printf(<font color="#666666">"parse_vars:0:t=(%s)\n"</font>,t);
<font color="#A020F0">#endif</font>
				e += strlen(bf-&gt;args[s[i] -'0']);
			}
			<font color="#4169E1">else</font> {
				*e = s[i];
				*(++e) = '\0';
			}
		}
		<font color="#4169E1">else</font> {
		    *e = s[i];
		    *(++e) = '\0';
		}
	}
}
<font color="#B22222">/***************************************************************************/</font>

<strong><font color="#4169E1"><a name="prevbat"></a>void prevbat(void)</font></strong>
{
    <font color="#4169E1">struct bfile</font> *obf;
<font color="#A020F0">#ifdef bat_debug</font>
printf(<font color="#666666">"prevbat:1:bf:%x bf-&gt;prev:%x\n"</font>,&amp;(*bf),bf-&gt;prev);
<font color="#A020F0">#endif</font>
    <font color="#4169E1">if</font>(bf-&gt;prev != NULL) {
        obf = bf-&gt;prev;
        free(bf);
        bf = obf;
<font color="#A020F0">#ifdef bat_debug</font>
printf(<font color="#666666">"prevbat:2:bf:%x bf-&gt;prev:%x\n"</font>,&amp;(*bf),bf-&gt;prev);
<font color="#A020F0">#endif</font>
    }
	<font color="#4169E1">return</font>;
}


<font color="#B22222">/***************************************************************************/</font>

<strong><font color="#4169E1"><a name="clearbat"></a>void clearbat(void)</font></strong>
{
    <font color="#4169E1">struct bfile</font> *obf;
<font color="#A020F0">#ifdef bat_debug</font>
printf(<font color="#666666">"clearbat:1:bf:%x bf-&gt;prev:%x\n"</font>,&amp;(*bf),bf-&gt;prev);
<font color="#A020F0">#endif</font>
    <font color="#4169E1">while</font>(1) {
        <font color="#4169E1">if</font>(bf-&gt;prev != NULL) {
            obf = bf-&gt;prev;
            free(bf);
            bf = obf;
        }
        <font color="#4169E1">else</font> {
            <font color="#4169E1">break</font>;
        }
<font color="#A020F0">#ifdef bat_debug</font>
printf(<font color="#666666">"clearbat:2:bf:%x bf-&gt;prev:%x\n"</font>,&amp;(*bf),bf-&gt;prev);
<font color="#A020F0">#endif</font>

    }
<font color="#A020F0">#ifdef bat_debug</font>
printf(<font color="#666666">"clearbat:3:bf:%x bf-&gt;prev:%x\n"</font>,&amp;(*bf),bf-&gt;prev);
<font color="#A020F0">#endif</font>
    <font color="#4169E1">return</font>;
}

<font color="#B22222">/**************************************************************************/</font>

<strong><font color="#4169E1"><a name="do_bat"></a>void do_bat(void)</font></strong>
{

    BYTE ll,i,na,ch, *p,*q;
    <font color="#4169E1">struct ffblk</font> *fba;
    FILE *fp;

<font color="#A020F0">#ifdef bat_debug</font>
printf(<font color="#666666">"do_bat:0:bf:%x name=|%s|\n"</font>,&amp;(*bf),bf-&gt;name);
<font color="#A020F0">#endif</font>

    <font color="#B22222">/*
    nest = 0 means that the batchfile is exed from the commandline
    nest &gt; 0 means bfile is jumped to from othe bfile -&gt; change name &amp; line
    in = 0 means not in bfile
    in = 1 means old bfile name is in bf-&gt;name
    */</font>

    <font color="#4169E1">if</font>(bf-&gt;in == 1) {
		fba = malloc(<font color="#4169E1">sizeof</font>(<font color="#4169E1">struct ffblk</font>));
        i=findfirst(bf-&gt;name,fba,0);
        <font color="#4169E1">if</font>(i==18) {
            fprintf(stderr,<font color="#666666">"Dogfile %s missing\n"</font>,bf-&gt;name);
            clearbat();
            bf-&gt;nest = 0;
            bf-&gt;in = 0;
            bf-&gt;line = 0;
            bf-&gt;na = 0;
			free(fba);
			<font color="#4169E1">for</font>(i=0;i&lt;bf-&gt;na;i++) {
				free(bf-&gt;args[i]);
			}
            <font color="#4169E1">return</font>;
        }
        <font color="#4169E1">else</font> <font color="#4169E1">if</font>(i==0) {
            fp = fopen(bf-&gt;name,<font color="#666666">"r"</font>);
            <font color="#4169E1">if</font>(fp==NULL) {
                fprintf(stderr,<font color="#666666">"Can't open DOGfile %s\n"</font>,bf-&gt;name);
	            clearbat();
	            bf-&gt;nest = 0;
	            bf-&gt;in = 0;
	            bf-&gt;line = 0;
	            bf-&gt;na = 0;
                <font color="#4169E1">for</font>(i=0;i&lt;bf-&gt;na;i++) {
                    free(bf-&gt;args[i]);
                }
                <font color="#4169E1">return</font>;
            }
        }
    }
	free(fba);

<font color="#A020F0">#ifdef bat_debug</font>
printf(<font color="#666666">"do_bat:4:bf-&gt;line=%d,bf-&gt;nest=%d\n"</font>,bf-&gt;line,bf-&gt;nest);
<font color="#A020F0">#endif</font>


<font color="#B22222">/* Return to the previous line as the batchfile is closed after each line*/</font>

    <font color="#4169E1">for</font>(i=0;i&lt;bf-&gt;line;i++) {
        fgets(com,200,fp);
    }

    <font color="#B22222">/* end of bfile:
                    if nest = 0 return
                    if nest &gt; 0 return one lvl down */</font>

    <font color="#4169E1">if</font> (fgets(com,200,fp) == NULL ) {
        <font color="#4169E1">if</font>(bf-&gt;nest == 0) {
            bf-&gt;in = 0;
            bf-&gt;line = 0;
            bf-&gt;na=0;
            fclose(fp);
            <font color="#4169E1">for</font>(i=0;i&lt;bf-&gt;na;i++) {
                free(bf-&gt;args[i]);
            }
            <font color="#4169E1">return</font>;
        }
        <font color="#4169E1">else</font> {
            prevbat();
            fclose(fp);
            <font color="#4169E1">for</font>(i=0;i&lt;bf-&gt;na;i++) {
                free(bf-&gt;args[i]);
            }
            <font color="#4169E1">return</font>;
        }

    }

	<font color="#B22222">/* extract $0..$9 to arg[0]..arg[9] */</font>

    bf-&gt;line++;
	p=malloc(200);

<font color="#A020F0">#ifdef parse_debug</font>
<font color="#4169E1">for</font>(i=0;i&lt;_NARGS;i++)
printf(<font color="#666666">"do_bat:0:bf-&gt;args[%d]=(%s)\n"</font>,i,bf-&gt;args[i]);
<font color="#A020F0">#endif</font>


	parse_vars(com,p);
	strcpy(com,p);
	free(p);

    <font color="#4169E1">if</font>(redir(com)==0) {
        com[0] = 0;
        arg[0] = com;
        <font color="#4169E1">for</font>(i=0;i&lt;bf-&gt;na;i++) {
            free(bf-&gt;args[i]);
        }
        <font color="#4169E1">return</font>;
    }
    ll=strlen(com);
    na = parsecom(com,ll);
    fclose(fp);

<font color="#A020F0">#ifdef bat_debug</font>
printf(<font color="#666666">"do_bat:5:ll=%d com=/%s/\n"</font>,i,com);
<font color="#A020F0">#endif</font>

<font color="#B22222">/* Check for ctrl break */</font>

    <font color="#4169E1">if</font>(cBreak) {
        <font color="#4169E1">if</font>(bf-&gt;in) {
            <font color="#4169E1">do</font> {
                fprintf(stderr,<font color="#666666">"Abort DOG batch (Y/N)? "</font>);
                ch = getchar();
                <font color="#4169E1">if</font>((ch=='y') || (ch=='Y')) {
                    clearbat();
                    cBreak = 0;
                    <font color="#4169E1">break</font>;
                }
                <font color="#4169E1">else</font> <font color="#4169E1">if</font>((ch=='n') || (ch=='N')) {
                    cBreak = 0;
                    <font color="#4169E1">break</font>;
				}
            } <font color="#4169E1">while</font> (1);
            fprintf(stderr,<font color="#666666">"\n"</font>);
            <font color="#4169E1">for</font>(i=0;i&lt;bf-&gt;na;i++) {
                free(bf-&gt;args[i]);
            }
            <font color="#4169E1">return</font>;
        }
        <font color="#4169E1">else</font> {
            cBreak = 0;
            <font color="#4169E1">return</font>;
        }
    }

    do_batcommand(na);

<font color="#A020F0">#ifdef bat_debug</font>
printf(<font color="#666666">"do_bat:7:i=%u\n"</font>,i);
<font color="#A020F0">#endif</font>
    <font color="#4169E1">for</font>(i=0;i&lt;bf-&gt;na;i++) {
        free(bf-&gt;args[i]);
    }
    <font color="#4169E1">return</font>;
}

<font color="#B22222">/**************************************************************************/</font>

<strong><font color="#4169E1"><a name="do_batcommand"></a>void do_batcommand(BYTE n)</font></strong>
{
    BYTE i;

<font color="#A020F0">#ifdef bat_debug</font>
printf(<font color="#666666">"n = %d\n"</font>,n);
<font color="#4169E1">for</font>(i=0;i&lt;n;i++)
printf(<font color="#666666">"bc:arg[%d]=(%s)\n"</font>,i,arg[i]);
<font color="#A020F0">#endif</font>

    <font color="#4169E1">if</font>(strlen(arg[0]) == 2) {
        <font color="#4169E1">for</font>(i=0;i&lt; _BAT_COMS;i++) {
<font color="#A020F0">#ifdef bat_debug</font>
printf(<font color="#666666">"bc:batch[%d]=(%s)\r"</font>,i,batch[i]);
<font color="#A020F0">#endif</font>
            <font color="#4169E1">if</font>(!stricmp(arg[0], batch[i]))
                <font color="#4169E1">break</font>;
        }

        <font color="#4169E1">switch</font>(i) {
            <font color="#4169E1">case</font> 0 :
                do_bp(n);
                <font color="#4169E1">return</font>;
            <font color="#4169E1">case</font> 1 :
                do_ca( n);
                <font color="#4169E1">return</font>;
            <font color="#4169E1">case</font> 2 :
                printf(<font color="#666666">"%s\n"</font>,batch[i]);
                <font color="#4169E1">return</font>;
            <font color="#4169E1">case</font> 3 :
                printf(<font color="#666666">"%s\n"</font>,batch[i]);
                <font color="#4169E1">return</font>;
            <font color="#4169E1">case</font> 4 :
                do_go(n);
                <font color="#4169E1">return</font>;
            <font color="#4169E1">case</font> 5 :
                printf(<font color="#666666">"%s\n"</font>,batch[i]);
                <font color="#4169E1">return</font>;
            <font color="#4169E1">case</font> 6 :
                printf(<font color="#666666">"%s\n"</font>,batch[i]);
                <font color="#4169E1">return</font>;
            <font color="#4169E1">case</font> 7 :
				do_sh(n);
                <font color="#4169E1">return</font>;
            <font color="#4169E1">case</font> 8 :
                printf(<font color="#666666">"%s\n"</font>,batch[i]);
                <font color="#4169E1">return</font>;
            <font color="#4169E1">default</font> :
                <font color="#4169E1">break</font>;

        }
        <font color="#4169E1">if</font>(arg[0][0] == ':')
        	<font color="#4169E1">return</font>;
        <font color="#4169E1">else</font> {
        	do_command(n);
          	<font color="#4169E1">return</font>;
        }
    }
    <font color="#4169E1">else</font> {
      	do_command(n);
       	<font color="#4169E1">return</font>;
	}
}

<font color="#B22222">/**************************************************************************/</font>


<strong><font color="#4169E1"><a name="do_go"></a>void do_go(BYTE n)</font></strong>
{
    BYTE l[121], *p,i,label[20];
    FILE *fp;
    <font color="#4169E1">if</font>(n &lt; 2)
        <font color="#4169E1">return</font>;
    strcpy(label,<font color="#666666">":"</font>);
    strcat(label,arg[1]);

    fp = fopen(bf-&gt;name,<font color="#666666">"r"</font>);
    <font color="#4169E1">if</font>(fp == NULL) {
        fprintf(stderr,<font color="#666666">"Batchfile %s missing.\n"</font>,bf-&gt;name);
        <font color="#4169E1">return</font>;
    }
    <font color="#4169E1">for</font>(i=0;1;i++) {
        p = fgets(l,120,fp);

<font color="#A020F0">#ifdef bat_debug</font>
printf(<font color="#666666">"label=%8s l=%s\n"</font>,label,l);
<font color="#A020F0">#endif</font>

        <font color="#B22222">/* EOF reached no label found*/</font>
        <font color="#4169E1">if</font> (p == NULL) {
            clearbat();
            bf-&gt;line=0;
            fclose(fp);
            <font color="#4169E1">return</font>;
        }
        <font color="#4169E1">if</font>(strnicmp(l,label,strlen(label))==0) {
            bf-&gt;line =i+1;
            fclose(fp);
            <font color="#4169E1">return</font>;
        }
    }
}

<font color="#B22222">/****************************************************************************/</font>


<strong><font color="#4169E1"><a name="do_ca"></a>void do_ca(BYTE n)</font></strong>
{
    BYTE i;
    <font color="#4169E1">struct bfile</font> *nbf;

<font color="#A020F0">#ifdef ca_debug</font>
printf(<font color="#666666">"do_ca:1:name=%s na=%u in=%u line=%u nest=%u\n"</font>,bf-&gt;name,bf-&gt;na,bf-&gt;in,bf-&gt;line,bf-&gt;nest);
printf(<font color="#666666">"do_ca:1:bf = %x\n"</font>,&amp;(*bf));
<font color="#A020F0">#endif</font>


    <font color="#4169E1">if</font>(n &gt;= 2) {
<font color="#B22222">/* set up for the new  bf*/</font>
        nbf = (<font color="#4169E1">struct bfile</font>*)malloc(<font color="#4169E1">sizeof</font>(<font color="#4169E1">struct bfile</font>));
        <font color="#4169E1">if</font> (nbf == NULL) {
            fprintf(stderr,<font color="#666666">"Out of memory in DOGfile"</font>);
        }

        <font color="#4169E1">for</font>(i=1;i&lt;n;i++) {
           nbf-&gt;args[i-1] = arg[i];
        }

        D = getcur(P) + 'A';
        sprintf(nbf-&gt;name,<font color="#666666">"%c:\\%s\\%s"</font>,D,P,arg[1]);

        nbf-&gt;na = n;
        nbf-&gt;line = 0;
        nbf-&gt;nest = bf-&gt;nest+1;
        nbf-&gt;in = 1;
        nbf-&gt;prev = bf;
        bf = nbf;
<font color="#A020F0">#ifdef ca_debug</font>
printf(<font color="#666666">"---------\n"</font>);
printf(<font color="#666666">"do_ca:2:name=%s na=%u in=%u line=%u nest=%u\n"</font>,bf-&gt;name,bf-&gt;na,bf-&gt;in,bf-&gt;line,bf-&gt;nest);
printf(<font color="#666666">"do_ca:3:bf = %x\n"</font>,&amp;(*bf));
<font color="#A020F0">#endif</font>
<font color="#B22222">/*        do_bat(); */</font>
<font color="#A020F0">#ifdef ca_debug</font>
printf(<font color="#666666">"do_ca:3:name=%s na=%u in=%u line=%u nest=%u\n"</font>,bf-&gt;name,bf-&gt;na,bf-&gt;in,bf-&gt;line,bf-&gt;nest);
printf(<font color="#666666">"do_ca:3:bf = %x\n"</font>,&amp;(*bf));
<font color="#A020F0">#endif</font>
    }

    <font color="#4169E1">return</font>;

}

<font color="#B22222">/****************************************************************************/</font>
<font color="#A020F0">#pragma argsused</font>
<strong><font color="#4169E1"><a name="do_sh"></a>void do_sh(BYTE n)</font></strong>
{
	BYTE i;
	<font color="#4169E1">for</font>(i=0;i&lt;10;i++)
		bf-&gt;args[i] = bf-&gt;args[i+1];
	<font color="#4169E1">return</font>;
}

</pre>


<!-- END of Table-->
</TD></tr></table>


</body>
</html>
</body>

</html>
